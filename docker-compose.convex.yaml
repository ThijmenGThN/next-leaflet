services:

  backend:
    image: ghcr.io/get-convex/convex-backend:latest
    restart: unless-stopped
    ports: [ "3210:3210", "3211:3211" ]
    volumes: [ "convex:/convex/data" ]
    environment:
      DISABLE_BEACON: "true"
      DO_NOT_REQUIRE_SSL: "1"
      INSTANCE_NAME: "convex-self-hosted"
      # Generate a new secret with `openssl rand -hex 32`.
      INSTANCE_SECRET: "0325575490a14277350af7c1c20c31d32dd2ce102b9766adee8b6d9acc468780"
      # Points to the MySQL database (WITHOUT database name).
      MYSQL_URL: "mysql://root:8nBAyt9SvGBzTbWBxBY5@database:3306"
      # Points to convex actions at port 3211 (Example: "https://cvx-actions.next-leaflet.app").
      CONVEX_SITE_ORIGIN: "http://localhost:3211"  
      # Points to convex api at port 3210 (Example: "https://cvx-api.next-leaflet.app").
      CONVEX_CLOUD_ORIGIN: "http://localhost:3210"
    stop_grace_period: 10s
    stop_signal: SIGINT
    healthcheck:
      test: curl -f http://localhost:3210/version
      interval: 5s
      start_period: 10s
    depends_on:
      database:
        condition: service_started

  dashboard:
    image: ghcr.io/get-convex/convex-dashboard:latest
    restart: unless-stopped
    ports: [ "6791:6791" ]
    environment:
      # Points to convex api at port 3210 (Example: "https://cvx-api.next-leaflet.app").
      NEXT_PUBLIC_DEPLOYMENT_URL: "http://localhost:3210"
    stop_grace_period: 10s
    stop_signal: SIGINT
    depends_on:
      backend:
        condition: service_healthy

  database:
    image: mysql:8.4
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: 8nBAyt9SvGBzTbWBxBY5
    volumes: [ "database:/var/lib/mysql" ]
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s

volumes:
  convex:
  database:
